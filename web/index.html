<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSE Chat Streaming</title>
  
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>
<body>
  <div class="container py-4">
    <div class="header">AI-PDB â€“ Trusted Knowledge Assistant</div>

    <div id="chat-box" class="mb-3"></div>

    <div class="input-group">
      <input type="text" id="query" class="form-control" placeholder="Type your question...">
      <button id="send" class="btn btn-primary">Send</button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    $("#send").click(function() {
      let query = $("#query").val().trim();
      if (!query) return;

      // Show user query
      $("#chat-box").append(`<div class="message user">${query}</div><div style="clear: both;"></div>`);
      $("#query").val("");
      $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);

      // Show progress status
      let statusMsg = $('<div class="message bot status">Extracting...</div>');
      $("#chat-box").append(statusMsg).append('<div style="clear: both;"></div>');
      $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);

      // Switch Extracting -> Processing after 1.5s
      setTimeout(() => {
        statusMsg.text("Processing...");
      }, 1500);

      // Connect to SSE API
      let source = new EventSource(`http://localhost:8000/query_stream?q=${encodeURIComponent(query)}`);

      let botMsg = null;
      let firstChunk = true;
      let streamDone = false;
      let sourcesReceived = false;

      // Handle normal streaming tokens
      source.onmessage = function(event) {
        if (event.data === "[DONE]") {
          console.log("Stream finished");
          streamDone = true;

          // Close only if sources already came
          if (sourcesReceived) {
            console.log("Closing SSE after DONE + sources");
            source.close();
          }
        } else {
          // When first chunk arrives, remove "Processing..." and create bot bubble
          if (firstChunk) {
            statusMsg.remove();
            botMsg = $('<div class="message bot"></div>');
            $("#chat-box").append(botMsg).append('<div style="clear: both;"></div>');
            firstChunk = false;
          }

          // Append streamed text
          botMsg.append(event.data);
          $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
        }
      };

      // Handle custom SSE events (like sources)
      source.addEventListener("sources", function(event) {
        console.log("Sources event received:", event.data);
        let files = JSON.parse(event.data);  // array of {filename, doctype, preview}

        if (files.length > 0) {
          let filesContainer = $('<div class="message bot files"><strong>ðŸ“‚ Related files:</strong><ul class="list-unstyled mt-2"></ul></div>');
          files.forEach(f => {
            filesContainer.find("ul").append(`
              <li class="mb-2">
                <a href="http://localhost:8000/download/${encodeURIComponent(f.filename)}" target="_blank">
                  ${f.filename}
                </a>
                ${f.doctype ? `<span class="badge bg-secondary ms-2">${f.doctype}</span>` : ""}
                ${f.preview ? `<div class="small text-muted">${f.preview}</div>` : ""}
              </li>
            `);
          });
          $("#chat-box").append(filesContainer).append('<div style="clear: both;"></div>');
          $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
        }

        sourcesReceived = true;

        // If streaming is already done, close now
        if (streamDone) {
          console.log("Closing SSE after sources");
          source.close();
        }
      });

      source.onerror = function(err) {
        console.error("SSE error:", err);
        source.close();
      };
    });
  });
</script>



</body>
</html>
