<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI-PDB Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    #chat-box {
      height: 70vh;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
    }
    .message { padding: 8px 12px; border-radius: 12px; margin: 6px 0; max-width: 80%; }
    .message.user { background: #007bff; color: #fff; margin-left: auto; text-align: right; }
    .message.bot { background: #e9ecef; color: #000; margin-right: auto; text-align: left; }
    .message.files { background: #f1f3f5; }
    .status { font-style: italic; }
  </style>
</head>
<body class="container py-4">

  <h2 class="mb-3">AI RAG Chat</h2>

  <!-- Toggle between Streaming & Full -->
  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" id="modeSwitch" checked>
    <label class="form-check-label" for="modeSwitch">Streaming Mode</label>
  </div>

  <!-- Chat Box -->
  <div id="chat-box"></div>

  <!-- Input -->
  <div class="input-group mt-3">
    <input type="text" id="query" class="form-control" placeholder="Type your question...">
    <button id="send" class="btn btn-primary">Send</button>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
    $(document).ready(function () {
      $("#send").click(function () {
        let query = $("#query").val().trim();
        if (!query) return;

        // Add user message
        $("#chat-box").append(`<div class="message user">${query}</div>`);
        $("#query").val("");
        $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);

        let streamingMode = $("#modeSwitch").is(":checked");

        if (streamingMode) {
          // --- STREAMING MODE (SSE) ---
          let statusMsg = $('<div class="message bot status">Extracting...</div>');
          $("#chat-box").append(statusMsg);
          $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);

          setTimeout(() => { statusMsg.text("Processing..."); }, 1500);

          let source = new EventSource(`http://localhost:8000/query_stream?q=${encodeURIComponent(query)}`);
          let botMsg = null;
          let firstChunk = true;

          source.onmessage = function (event) {
            if (event.data === "[DONE]") {
              source.close();
            } else {
              if (firstChunk) {
                statusMsg.remove();
                botMsg = $('<div class="message bot"></div>');
                $("#chat-box").append(botMsg);
                firstChunk = false;
              }
              botMsg.append(event.data);
              $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
            }
          };

          source.addEventListener("sources", function (event) {
            let files = JSON.parse(event.data);
            if (files.length > 0) {
              let filesContainer = $('<div class="message bot files"><strong>ðŸ“‚ Related files:</strong><ul class="list-unstyled mt-2"></ul></div>');
              files.forEach(f => {
                filesContainer.find("ul").append(`
                  <li class="mb-2">
                    <a href="http://localhost:8000/download/${encodeURIComponent(f.filename)}" target="_blank">
                      ${f.filename}
                    </a>
                    ${f.doctype ? `<span class="badge bg-secondary ms-2">${f.doctype}</span>` : ""}
                    ${f.preview ? `<div class="small text-muted">${f.preview}</div>` : ""}
                  </li>
                `);
              });
              $("#chat-box").append(filesContainer);
              $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);
            }
          });

          source.onerror = function (err) {
            console.error("SSE error:", err);
            source.close();
          };

        } else {
          // --- FULL RESPONSE MODE ---
          let shownFiles = new Set();
          let waitingMsg = $('<div class="message bot status">Waiting for response...</div>');
          $("#chat-box").append(waitingMsg);
          $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);

          $.getJSON(`http://localhost:8000/query?q=${encodeURIComponent(query)}`, function (res) {
            waitingMsg.remove();
            $("#chat-box").append(`<div class="message bot">${res.answer}</div>`);
            if (res.sources && res.sources.length > 0) {
              let filesContainer = $('<div class="message bot files"><strong>ðŸ“‚ Related files:</strong><ul class="list-unstyled mt-2"></ul></div>');
              res.sources.forEach(f => {
               if (!shownFiles.has(f.filename)) {
                 shownFiles.add(f.filename);
                filesContainer.find("ul").append(`
                  <li class="mb-2">
                    <a href="http://localhost:8000/download/${encodeURIComponent(f.filename)}" target="_blank">
                      ${f.filename}
                    </a>
                    ${f.doctype ? `<span class="badge bg-secondary ms-2">${f.doctype}</span>` : ""}
                    ${f.preview ? `<div class="small text-muted">${f.preview}</div>` : ""}
                  </li>
                `);
                }

              });
              if (filesContainer.find("ul li").length > 0) {
                 $("#chat-box").append(filesContainer);
              }
            }
          });
        }
      });
    });
  </script>
</body>
</html>
